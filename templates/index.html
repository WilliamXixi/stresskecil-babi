<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TUKANG OPREK</title>
  <style>
    body {
  background: url('/static/background.jpg') no-repeat center center fixed;
  background-size: cover;
      color: white;
      padding: 20px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }

    form {
      background: rgba(0, 0, 0, 0.6);
      padding: 20px;
      border-radius: 10px;
      max-width: 500px;
      flex: 1;
      min-width: 300px;
    }

    textarea, input, button {
      width: 100%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 5px;
      border: none;
    }

    button {
      cursor: pointer;
    }

    #output, #logConsole {
      background: rgba(0,0,0,0.6);
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: 14px;
      overflow-y: auto;
    }

    #logConsole {
      max-height: 600px;
      flex: 1;
      min-width: 300px;
    }
  </style>
</head>
<body>
  <form id="waForm">
    <h2>üöÄ Kirim Pesan WhatsApp</h2>
    <h2>üöÄ DEX STILL LIVE </h2>
    <label>API Token:</label>
    <input type="text" name="api_token" required>

    <label>Phone Number ID:</label>
    <input type="text" name="phone_number_id" required>

    <label>Template ID (satu per baris, akan dipilih acak):</label>
	<label>DEXSAILOR (Dimohon pakai 3 template langsung untuk mencegah generic):</label>
    <textarea name="template_ids" rows="3" required></textarea>

    <label>Nomor WhatsApp (satu per baris):</label>
    <textarea name="phone_numbers" rows="10" required></textarea>

    <label>Jeda acak antar pesan (detik, cth: 2-10):</label>
    <input type="text" name="delay" value="2-10" placeholder="cth: 2-10" required>

    <button type="submit">‚ñ∂Ô∏è Kirim Pesan</button>
    <button type="button" id="stopBtn" style="background-color: red; margin-top: 10px;">‚õî Hentikan</button>

    <div id="output"></div>
  </form>

  <div id="logConsole">
    <h3>üìã Log Pengiriman:</h3>
    <div id="logBody"></div>
  </div>

 <script>
  let stop = false;
  let successCount = 0;
  let failCount = 0;

  const logConsole = (text) => {
    const logBody = document.getElementById("logBody");
    logBody.innerHTML += text + "<br>";
    logBody.scrollTop = logBody.scrollHeight;
  };

  document.getElementById('stopBtn').addEventListener('click', () => {
    stop = true;
    logConsole("üõë Pengiriman dihentikan manual.");
  });

  document.getElementById('waForm').addEventListener('submit', async function (e) {
    e.preventDefault();
    stop = false;
    successCount = 0;
    failCount = 0;
    document.getElementById('output').innerHTML = '‚è≥ Mengirim pesan...<br>';
    document.getElementById('logBody').innerHTML = '';

    const form = e.target;
    const phoneNumbers = form.phone_numbers.value.trim().split('\n').map(p => p.trim()).filter(p => p);

    // --- PERUBAHAN UTAMA: Memproses delay acak ---
    const delayInput = form.delay.value.trim();
    const delayRange = delayInput.split('-').map(Number);
    
    // Validasi input delay
    if (delayRange.length !== 2 || isNaN(delayRange[0]) || isNaN(delayRange[1]) || delayRange[0] >= delayRange[1]) {
      logConsole("‚ùå Format delay salah. Gunakan format 'min-max' (misal: 2-10).");
      return;
    }
    const minDelay = delayRange[0] * 1000;
    const maxDelay = delayRange[1] * 1000;

    const templateIds = form.template_ids.value.trim().split('\n').map(id => id.trim()).filter(id => id);

    if (templateIds.length === 0) {
      logConsole("‚ùå Harap masukkan setidaknya satu Template ID.");
      return;
    }

    for (let i = 0; i < phoneNumbers.length; i++) {
      if (stop) break;

      const userID = i + 1;
      const phone_number = phoneNumbers[i];
      
      const randomTemplateId = templateIds[Math.floor(Math.random() * templateIds.length)];

      logConsole(`üî¢ User ID: ${userID} | Nomor: ${phone_number} | Template: ${randomTemplateId} ‚û°Ô∏è Mengirim...`);

      try {
        const res = await fetch('/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            api_token: form.api_token.value.trim(),
            phone_number_id: form.phone_number_id.value.trim(),
            template_id: randomTemplateId, 
            phone_number
          })
        });

        const result = await res.json();
        
        if (res.ok && result.success) {
          successCount++;
          logConsole(`‚úÖ User ID: ${userID} | ${phone_number} - ${result.message}`);
        } else {
          failCount++;
          logConsole(`‚ùå User ID: ${userID} | ${phone_number} - ${result.message || 'Gagal mengirim'}`);
        }

      } catch (err) {
        failCount++;
        logConsole(`‚ùå User ID: ${userID} | ${phone_number} - Gagal karena error: ${err.message}`);
      }
      
      document.getElementById('output').innerHTML = `üìä ${successCount} berhasil, ${failCount} gagal dari ${phoneNumbers.length}`;

      if (i < phoneNumbers.length - 1) {
        // --- PERUBAHAN UTAMA: Menghitung delay acak ---
        const randomDelay = Math.floor(Math.random() * (maxDelay - minDelay + 1)) + minDelay;
        const randomDelayInSeconds = (randomDelay / 1000).toFixed(2);
        logConsole(`‚è≥ Menunggu ${randomDelayInSeconds} detik sebelum pesan berikutnya...`);
        await new Promise(resolve => setTimeout(resolve, randomDelay));
      }
    }

    if (!stop) {
      logConsole(`üéâ Semua pesan selesai diproses. Total: ${successCount} berhasil, ${failCount} gagal.`);
      document.getElementById('output').innerHTML += '<br>‚úîÔ∏è Selesai!';
    }
  });
</script>

</body>
</html>


